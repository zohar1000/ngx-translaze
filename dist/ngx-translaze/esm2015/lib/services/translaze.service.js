import { ComponentFactoryResolver, Inject, Injectable } from '@angular/core';
import { TRANSLAZE_CONFIG } from '../tokens/translaze-config.token';
import { BehaviorSubject, ReplaySubject } from 'rxjs';
import { BaseTranslazeService } from './base-translaze.service';
import { TranslazeLangStatus } from '../enums/translaze-lang-status.enum';
import * as i0 from "@angular/core";
import * as i1 from "../tokens/translaze-config.token";
export class TranslazeService extends BaseTranslazeService {
    constructor(componentFactoryResolver, config) {
        super(componentFactoryResolver, config);
        this.FALLBACK_LANG = 'en';
        this.DEFAULT_USE_BROWSER_DEFAULT_LANG = true;
        this.DEFAULT_LOCAL_STORAGE_KEY = 'translaze';
        this.langCode = '';
        this.langName = '';
        this.text$ = new BehaviorSubject('');
        this.lang$ = new ReplaySubject(1);
        this.isText$ = new BehaviorSubject(false);
        this.appText$ = this.text$;
    }
    changeLang(langCode) {
        this.lang$.next({ status: TranslazeLangStatus.Start, langCode, prevLangCode: this.langCode });
        super.changeLang(langCode);
    }
    onNewLangReady(langCode) {
        super.onNewLangReady(langCode);
        this.langCode = langCode;
        this.langName = this.getConfig().langs.find(item => item.code === this.langCode).name;
        this.updateLocalStorage(langCode);
        if (this.config.onLangTextReady)
            this.config.onLangTextReady(this.langs[langCode]);
        this.lang$.next({ status: TranslazeLangStatus.Complete, langCode });
        this.text$.next(this.langs[langCode]);
        this.isText$.next(true);
    }
    updateLocalStorage(langCode) {
        const lsItem = { langCode };
        const localStorageKey = this.getConfig().localStorageKey || this.DEFAULT_LOCAL_STORAGE_KEY;
        localStorage.setItem(localStorageKey, JSON.stringify(lsItem));
    }
    getConfig() {
        return this.config;
    }
    getInitialLangCode() {
        const lsStr = localStorage.getItem(this.getConfig().localStorageKey);
        let langCode;
        if (lsStr) {
            const lsItem = JSON.parse(lsStr);
            langCode = lsItem.langCode;
        }
        else {
            let langItem;
            let isUseBrowserDefaultLang = this.getConfig().isUseBrowserDefaultLang;
            if (isUseBrowserDefaultLang === undefined)
                isUseBrowserDefaultLang = this.DEFAULT_USE_BROWSER_DEFAULT_LANG;
            if (isUseBrowserDefaultLang && navigator) {
                langCode = navigator.language;
                langItem = this.config.langs.find(item => item.code.toLowerCase() === langCode.toLowerCase());
                if (!langItem) {
                    langCode = langCode.substr(0, 2);
                    langItem = this.config.langs.find(item => item.code.toLowerCase() === langCode.toLowerCase());
                }
                if (!langItem)
                    langCode = '';
            }
            if (!langCode) {
                langItem = this.config.langs.find(item => item.default);
                if (langItem)
                    langCode = langItem.code;
            }
            if (!langCode)
                langCode = this.FALLBACK_LANG;
        }
        return langCode;
    }
    getInfo() {
        return {
            config: this.getConfig(),
            langCode: this.langCode,
            langName: this.langName
        };
    }
}
TranslazeService.ɵprov = i0.ɵɵdefineInjectable({ factory: function TranslazeService_Factory() { return new TranslazeService(i0.ɵɵinject(i0.ComponentFactoryResolver), i0.ɵɵinject(i1.TRANSLAZE_CONFIG)); }, token: TranslazeService, providedIn: "root" });
TranslazeService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
TranslazeService.ctorParameters = () => [
    { type: ComponentFactoryResolver },
    { type: undefined, decorators: [{ type: Inject, args: [TRANSLAZE_CONFIG,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNsYXplLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtdHJhbnNsYXplL3NyYy9saWIvc2VydmljZXMvdHJhbnNsYXplLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHN0UsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDcEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFHaEUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0scUNBQXFDLENBQUM7OztBQUcxRSxNQUFNLE9BQU8sZ0JBQWlCLFNBQVEsb0JBQW9CO0lBVXhELFlBQVksd0JBQWtELEVBQ3hCLE1BQXVCO1FBQzNELEtBQUssQ0FBQyx3QkFBd0IsRUFBRSxNQUFNLENBQUMsQ0FBQztRQVhqQyxrQkFBYSxHQUFHLElBQUksQ0FBQztRQUNyQixxQ0FBZ0MsR0FBRyxJQUFJLENBQUM7UUFDeEMsOEJBQXlCLEdBQUcsV0FBVyxDQUFDO1FBQ3pDLGFBQVEsR0FBRyxFQUFFLENBQUM7UUFDZCxhQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ3RCLFVBQUssR0FBNkIsSUFBSSxlQUFlLENBQVUsRUFBRSxDQUFDLENBQUM7UUFDbkUsVUFBSyxHQUFpQyxJQUFJLGFBQWEsQ0FBZ0IsQ0FBQyxDQUFDLENBQUM7UUFDMUUsWUFBTyxHQUFHLElBQUksZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBS25DLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztJQUM3QixDQUFDO0lBRU0sVUFBVSxDQUFDLFFBQVE7UUFDeEIsSUFBSSxDQUFDLEtB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QUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEtBQUssUUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7aUJBQy9GO2dCQUNELElBQUksQ0FBQyxRQUFRO29CQUFFLFFBQVEsR0FBRyxFQUFFLENBQUM7YUFDOUI7WUFDRCxJQUFJLENBQUMsUUFBUSxFQUFFO2dCQUNiLFFBQVEsR0FBSSxJQUFJLENBQUMsTUFBMEIsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUM3RSxJQUFJLFFBQVE7b0JBQUUsUUFBUSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUM7YUFDeEM7WUFDRCxJQUFJLENBQUMsUUFBUTtnQkFBRSxRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQztTQUM5QztRQUNELE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFTSxPQUFPO1FBQ1osT0FBTztZQUNMLE1BQU0sRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ3hCLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtZQUN2QixRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7U0FDeEIsQ0FBQztJQUNKLENBQUM7Ozs7WUE3RUYsVUFBVSxTQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRTs7O1lBVnpCLHdCQUF3Qjs0Q0FzQmxCLE1BQU0sU0FBQyxnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIEluamVjdCwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVHJhbnNsYXplTG9jYWxTdG9yYWdlIH0gZnJvbSAnLi4vbW9kZWxzL3RyYW5zbGF6ZS1sb2NhbC1zdG9yYWdlLm1vZGVsJztcbmltcG9ydCB7IFRyYW5zbGF6ZUNvbmZpZyB9IGZyb20gJy4uL21vZGVscy9jb25maWcvdHJhbnNsYXplLWNvbmZpZy5tb2RlbCc7XG5pbXBvcnQgeyBUUkFOU0xBWkVfQ09ORklHIH0gZnJvbSAnLi4vdG9rZW5zL3RyYW5zbGF6ZS1jb25maWcudG9rZW4nO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBCYXNlVHJhbnNsYXplU2VydmljZSB9IGZyb20gJy4vYmFzZS10cmFuc2xhemUuc2VydmljZSc7XG5pbXBvcnQgeyBUcmFuc2xhemVJbmZvIH0gZnJvbSAnLi4vbW9kZWxzL2luZm8vdHJhbnNsYXplLWluZm8ubW9kZWwnO1xuaW1wb3J0IHsgVHJhbnNsYXplTGFuZyB9IGZyb20gJy4uL21vZGVscy90cmFuc2xhemUtbGFuZy5tb2RlbCc7XG5pbXBvcnQgeyBUcmFuc2xhemVMYW5nU3RhdHVzIH0gZnJvbSAnLi4vZW51bXMvdHJhbnNsYXplLWxhbmctc3RhdHVzLmVudW0nO1xuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIFRyYW5zbGF6ZVNlcnZpY2UgZXh0ZW5kcyBCYXNlVHJhbnNsYXplU2VydmljZSB7XG4gIHJlYWRvbmx5IEZBTExCQUNLX0xBTkcgPSAnZW4nO1xuICByZWFkb25seSBERUZBVUxUX1VTRV9CUk9XU0VSX0RFRkFVTFRfTEFORyA9IHRydWU7XG4gIHJlYWRvbmx5IERFRkFVTFRfTE9DQUxfU1RPUkFHRV9LRVkgPSAndHJhbnNsYXplJztcbiAgcHJpdmF0ZSBsYW5nQ29kZSA9ICcnO1xuICBwcml2YXRlIGxhbmdOYW1lID0gJyc7XG4gIHRleHQkOiBCZWhhdmlvclN1YmplY3Q8dW5rbm93bj4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHVua25vd24+KCcnKTtcbiAgbGFuZyQ6IFJlcGxheVN1YmplY3Q8VHJhbnNsYXplTGFuZz4gPSBuZXcgUmVwbGF5U3ViamVjdDxUcmFuc2xhemVMYW5nPigxKTtcbiAgaXNUZXh0JCA9IG5ldyBCZWhhdmlvclN1YmplY3QoZmFsc2UpO1xuXG4gIGNvbnN0cnVjdG9yKGNvbXBvbmVudEZhY3RvcnlSZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgICAgICAgICAgICBASW5qZWN0KFRSQU5TTEFaRV9DT05GSUcpIGNvbmZpZzogVHJhbnNsYXplQ29uZmlnKSB7XG4gICAgc3VwZXIoY29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBjb25maWcpO1xuICAgIHRoaXMuYXBwVGV4dCQgPSB0aGlzLnRleHQkO1xuICB9XG5cbiAgcHVibGljIGNoYW5nZUxhbmcobGFuZ0NvZGUpIHtcbiAgICB0aGlzLmxhbmckLm5leHQoeyBzdGF0dXM6IFRyYW5zbGF6ZUxhbmdTdGF0dXMuU3RhcnQsIGxhbmdDb2RlLCBwcmV2TGFuZ0NvZGU6IHRoaXMubGFuZ0NvZGUgfSk7XG4gICAgc3VwZXIuY2hhbmdlTGFuZyhsYW5nQ29kZSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgb25OZXdMYW5nUmVhZHkobGFuZ0NvZGUpIHtcbiAgICBzdXBlci5vbk5ld0xhbmdSZWFkeShsYW5nQ29kZSk7XG4gICAgdGhpcy5sYW5nQ29kZSA9IGxhbmdDb2RlO1xuICAgIHRoaXMubGFuZ05hbWUgPSB0aGlzLmdldENvbmZpZygpLmxhbmdzLmZpbmQoaXRlbSA9PiBpdGVtLmNvZGUgPT09IHRoaXMubGFuZ0NvZGUpLm5hbWU7XG4gICAgdGhpcy51cGRhdGVMb2NhbFN0b3JhZ2UobGFuZ0NvZGUpO1xuICAgIGlmICh0aGlzLmNvbmZpZy5vbkxhbmdUZXh0UmVhZHkpIHRoaXMuY29uZmlnLm9uTGFuZ1RleHRSZWFkeSh0aGlzLmxhbmdzW2xhbmdDb2RlXSk7XG4gICAgdGhpcy5sYW5nJC5uZXh0KHsgc3RhdHVzOiBUcmFuc2xhemVMYW5nU3RhdHVzLkNvbXBsZXRlLCBsYW5nQ29kZSB9KTtcbiAgICAodGhpcy50ZXh0JCBhcyBCZWhhdmlvclN1YmplY3Q8dW5rbm93bj4pLm5leHQodGhpcy5sYW5nc1tsYW5nQ29kZV0pO1xuICAgIHRoaXMuaXNUZXh0JC5uZXh0KHRydWUpO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVMb2NhbFN0b3JhZ2UobGFuZ0NvZGUpIHtcbiAgICBjb25zdCBsc0l0ZW06IFRyYW5zbGF6ZUxvY2FsU3RvcmFnZSA9IHsgbGFuZ0NvZGUgfTtcbiAgICBjb25zdCBsb2NhbFN0b3JhZ2VLZXkgPSB0aGlzLmdldENvbmZpZygpLmxvY2FsU3RvcmFnZUtleSB8fCB0aGlzLkRFRkFVTFRfTE9DQUxfU1RPUkFHRV9LRVk7XG4gICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0obG9jYWxTdG9yYWdlS2V5LCBKU09OLnN0cmluZ2lmeShsc0l0ZW0pKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb25maWcoKTogVHJhbnNsYXplQ29uZmlnIHtcbiAgICByZXR1cm4gdGhpcy5jb25maWcgYXMgVHJhbnNsYXplQ29uZmlnO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldEluaXRpYWxMYW5nQ29kZSgpIHtcbiAgICBjb25zdCBsc1N0ciA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMuZ2V0Q29uZmlnKCkubG9jYWxTdG9yYWdlS2V5KTtcbiAgICBsZXQgbGFuZ0NvZGU7XG4gICAgaWYgKGxzU3RyKSB7XG4gICAgICBjb25zdCBsc0l0ZW06IFRyYW5zbGF6ZUxvY2FsU3RvcmFnZSA9IEpTT04ucGFyc2UobHNTdHIpO1xuICAgICAgbGFuZ0NvZGUgPSBsc0l0ZW0ubGFuZ0NvZGU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBsYW5nSXRlbTtcbiAgICAgIGxldCBpc1VzZUJyb3dzZXJEZWZhdWx0TGFuZyA9IHRoaXMuZ2V0Q29uZmlnKCkuaXNVc2VCcm93c2VyRGVmYXVsdExhbmc7XG4gICAgICBpZiAoaXNVc2VCcm93c2VyRGVmYXVsdExhbmcgPT09IHVuZGVmaW5lZCApIGlzVXNlQnJvd3NlckRlZmF1bHRMYW5nID0gdGhpcy5ERUZBVUxUX1VTRV9CUk9XU0VSX0RFRkFVTFRfTEFORztcbiAgICAgIGlmIChpc1VzZUJyb3dzZXJEZWZhdWx0TGFuZyAmJiBuYXZpZ2F0b3IpIHtcbiAgICAgICAgbGFuZ0NvZGUgPSBuYXZpZ2F0b3IubGFuZ3VhZ2U7XG4gICAgICAgIGxhbmdJdGVtID0gdGhpcy5jb25maWcubGFuZ3MuZmluZChpdGVtID0+IGl0ZW0uY29kZS50b0xvd2VyQ2FzZSgpID09PSBsYW5nQ29kZS50b0xvd2VyQ2FzZSgpKTtcbiAgICAgICAgaWYgKCFsYW5nSXRlbSkge1xuICAgICAgICAgIGxhbmdDb2RlID0gbGFuZ0NvZGUuc3Vic3RyKDAsIDIpO1xuICAgICAgICAgIGxhbmdJdGVtID0gdGhpcy5jb25maWcubGFuZ3MuZmluZChpdGVtID0+IGl0ZW0uY29kZS50b0xvd2VyQ2FzZSgpID09PSBsYW5nQ29kZS50b0xvd2VyQ2FzZSgpKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIWxhbmdJdGVtKSBsYW5nQ29kZSA9ICcnO1xuICAgICAgfVxuICAgICAgaWYgKCFsYW5nQ29kZSkge1xuICAgICAgICBsYW5nSXRlbSA9ICh0aGlzLmNvbmZpZyBhcyBUcmFuc2xhemVDb25maWcpLmxhbmdzLmZpbmQoaXRlbSA9PiBpdGVtLmRlZmF1bHQpO1xuICAgICAgICBpZiAobGFuZ0l0ZW0pIGxhbmdDb2RlID0gbGFuZ0l0ZW0uY29kZTtcbiAgICAgIH1cbiAgICAgIGlmICghbGFuZ0NvZGUpIGxhbmdDb2RlID0gdGhpcy5GQUxMQkFDS19MQU5HO1xuICAgIH1cbiAgICByZXR1cm4gbGFuZ0NvZGU7XG4gIH1cblxuICBwdWJsaWMgZ2V0SW5mbygpOiBUcmFuc2xhemVJbmZvIHtcbiAgICByZXR1cm4ge1xuICAgICAgY29uZmlnOiB0aGlzLmdldENvbmZpZygpLFxuICAgICAgbGFuZ0NvZGU6IHRoaXMubGFuZ0NvZGUsXG4gICAgICBsYW5nTmFtZTogdGhpcy5sYW5nTmFtZVxuICAgIH07XG4gIH1cblxuICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqL1xuICAvKiAgICAgIEYgRSBBIFQgVSBSIEUgICAgICAqL1xuICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqL1xuLypcbiAgc2V0RmVhdHVyZU1vZHVsZShjb25maWc6IFRyYW5zbGF6ZUZlYXR1cmVDb25maWcpIHtcbiAgICBjb25zb2xlLmxvZygnc2V0RmVhdHVyZU1vZHVsZTonLCBjb25maWcpO1xuICAgIGlmICghY29uZmlnLmZlYXR1cmVJZCkge1xuICAgICAgY29uc29sZS5lcnJvcignQSBmZWF0dXJlIGxhbmd1YWdlIHdhcyBjb25maWd1cmVkIGJ1dCBpdCBoYXMgbm8gXCJmZWF0dXJlSWRcIiBwcm9wZXJ0eSwgdGhlIGxhbmd1YWdlIGZpbGUgZm9yIHRoaXMgbW9kdWxlIHdpbGwgbm90IGJlIGxvYWRlZC4gY29uZmlnOicsIGNvbmZpZyk7XG4gICAgfVxuICAgIC8vIGlmICh0aGlzLmZlYXR1cmVNb2R1bGVzW2NvbmZpZy5mZWF0dXJlSWRdKVxuICB9Ki9cbn1cbiJdfQ==